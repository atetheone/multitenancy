# CLAUDE.md - Projet E-commerce Backend AdonisJS

## üéØ Vue d'ensemble du Projet

**Objectif**: D√©velopper un backend e-commerce multi-tenant complet avec AdonisJS v6 en 3 jours intensifs, pr√™t pour l'int√©gration frontend.

**Architecture**: Monolithe modulaire avec s√©paration des domaines selon les principes DDD (Domain-Driven Design).

**Stack Technique**:

- **Framework**: AdonisJS v6 (TypeScript, ESM)
- **Base de donn√©es**: PostgreSQL
- **Authentification**: JWT avec `@maximemrf/adonisjs-jwt`
- **ORM**: Lucid (AdonisJS)
- **Validation**: VineJS
- **Tests**: Japa (should have)

---

## üèóÔ∏è Architecture Modulaire

### Principe DDD Appliqu√©

**S√©paration des pr√©occupations**:

- **Auth Module**: Authentification (AuthN) et Autorisation (AuthZ) uniquement
- **User Module**: Gestion des utilisateurs et profils (domaine m√©tier)
- **Autres modules**: Chacun avec sa responsabilit√© sp√©cifique

### Structure des Modules

````

app/modules/
‚îú‚îÄ‚îÄ auth/ # P0 - S√©curit√© & Acc√®s
‚îÇ ‚îú‚îÄ‚îÄ controllers/
‚îÇ ‚îú‚îÄ‚îÄ services/
‚îÇ ‚îú‚îÄ‚îÄ middleware/
‚îÇ ‚îú‚îÄ‚îÄ validators/
‚îÇ ‚îú‚îÄ‚îÄ exceptions/
‚îÇ ‚îú‚îÄ‚îÄ events/
‚îÇ ‚îî‚îÄ‚îÄ routes/
‚îú‚îÄ‚îÄ user/ # P0 - Gestion Utilisateurs
‚îú‚îÄ‚îÄ tenant/ # P0 - Multi-tenant
‚îú‚îÄ‚îÄ rbac/ # P1 - R√¥les & Permissions
‚îú‚îÄ‚îÄ catalog/ # P0 - Produits & Catalogue
‚îú‚îÄ‚îÄ cart/ # P0 - Panier d'achat
‚îú‚îÄ‚îÄ order/ # P0 - Commandes
‚îú‚îÄ‚îÄ payment/ # P1 - Paiements
‚îú‚îÄ‚îÄ delivery/ # P1 - Livraisons
‚îî‚îÄ‚îÄ notification/ # P2 - Notifications

````

### Commande Make:Module

```bash
# G√©n√©rer un nouveau module
node ace make:module [name] -m -migration -t -d [domain]

# Exemples
node ace make:module auth -d security
node ace make:module user -m -migration -t -d user_management
node ace make:module catalog -m -migration -d commerce
````

---

## üóÑÔ∏è Sch√©ma de Base de Donn√©es Complet

### Tables Core (Authentication & Users)

#### **users**

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    email VARCHAR(100) UNIQUE NOT NULL,
    password VARCHAR(255) NOT NULL,
    email_verified_at TIMESTAMP NULL,
    remember_me_token VARCHAR(255) NULL,
    status VARCHAR(20) CHECK (status IN ('active', 'inactive', 'suspended')) DEFAULT 'active',
    last_login_at TIMESTAMP NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### **user_profiles**

```sql
CREATE TABLE user_profiles (
    id SERIAL PRIMARY KEY,
    user_id INTEGER UNIQUE REFERENCES users(id) ON DELETE CASCADE,
    first_name VARCHAR(50),
    last_name VARCHAR(50),
    phone VARCHAR(20),
    date_of_birth DATE,
    profile_picture_url VARCHAR(255),
    preferred_language VARCHAR(10) DEFAULT 'fr',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### Tables Multi-Tenant

#### **tenants**

```sql
CREATE TABLE tenants (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    domain VARCHAR(255) UNIQUE NULL,
    description TEXT,
    logo VARCHAR(255),
    settings JSONB DEFAULT '{}',
    status VARCHAR(20) CHECK (status IN ('active', 'inactive', 'suspended')) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### **user_tenants** (Many-to-Many)

```sql
CREATE TABLE user_tenants (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    tenant_id INTEGER REFERENCES tenants(id) ON DELETE CASCADE,
    status VARCHAR(20) CHECK (status IN ('active', 'inactive', 'pending')) DEFAULT 'active',
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, tenant_id)
);
```

### Tables RBAC (Role-Based Access Control)

#### **roles**

```sql
CREATE TABLE roles (
    id SERIAL PRIMARY KEY,
    name VARCHAR(50) NOT NULL,
    display_name VARCHAR(100) NOT NULL,
    description TEXT,
    tenant_id INTEGER REFERENCES tenants(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(name, tenant_id)
);
```

#### **permissions**

```sql
CREATE TABLE permissions (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    resource VARCHAR(50) NOT NULL,
    action VARCHAR(50) NOT NULL,
    tenant_id INTEGER REFERENCES tenants(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(name, tenant_id)
);
```

#### **role_permissions** & **user_roles**

```sql
CREATE TABLE role_permissions (
    id SERIAL PRIMARY KEY,
    role_id INTEGER REFERENCES roles(id) ON DELETE CASCADE,
    permission_id INTEGER REFERENCES permissions(id) ON DELETE CASCADE,
    UNIQUE(role_id, permission_id)
);

CREATE TABLE user_roles (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    role_id INTEGER REFERENCES roles(id) ON DELETE CASCADE,
    UNIQUE(user_id, role_id)
);
```

### Tables E-commerce

#### **categories** (Hi√©rarchique)

```sql
CREATE TABLE categories (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    slug VARCHAR(100) NOT NULL,
    description TEXT,
    parent_id INTEGER REFERENCES categories(id) ON DELETE SET NULL,
    tenant_id INTEGER REFERENCES tenants(id) ON DELETE CASCADE,
    is_active BOOLEAN DEFAULT true,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(slug, tenant_id)
);
```

#### **products**

```sql
CREATE TABLE products (
    id SERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    slug VARCHAR(255) NOT NULL,
    description TEXT,
    short_description VARCHAR(500),
    sku VARCHAR(100) NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    compare_price DECIMAL(10,2),
    cost_price DECIMAL(10,2),
    track_inventory BOOLEAN DEFAULT true,
    status VARCHAR(20) CHECK (status IN ('active', 'inactive', 'draft')) DEFAULT 'draft',
    tenant_id INTEGER REFERENCES tenants(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(slug, tenant_id),
    UNIQUE(sku, tenant_id)
);
```

#### **product_images**

```sql
CREATE TABLE product_images (
    id SERIAL PRIMARY KEY,
    product_id INTEGER REFERENCES products(id) ON DELETE CASCADE,
    url VARCHAR(255) NOT NULL,
    alt_text VARCHAR(255),
    is_primary BOOLEAN DEFAULT false,
    sort_order INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### **category_products** (Many-to-Many)

```sql
CREATE TABLE category_products (
    id SERIAL PRIMARY KEY,
    category_id INTEGER REFERENCES categories(id) ON DELETE CASCADE,
    product_id INTEGER REFERENCES products(id) ON DELETE CASCADE,
    UNIQUE(category_id, product_id)
);
```

#### **inventory**

```sql
CREATE TABLE inventory (
    id SERIAL PRIMARY KEY,
    product_id INTEGER REFERENCES products(id) ON DELETE CASCADE,
    quantity INTEGER NOT NULL DEFAULT 0,
    reserved_quantity INTEGER DEFAULT 0,
    location VARCHAR(100),
    tenant_id INTEGER REFERENCES tenants(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(product_id, tenant_id)
);
```

#### **carts** & **cart_items**

```sql
CREATE TABLE carts (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    tenant_id INTEGER REFERENCES tenants(id) ON DELETE CASCADE,
    status VARCHAR(20) CHECK (status IN ('active', 'converted', 'abandoned')) DEFAULT 'active',
    session_id VARCHAR(255),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, tenant_id)
);

CREATE TABLE cart_items (
    id SERIAL PRIMARY KEY,
    cart_id INTEGER REFERENCES carts(id) ON DELETE CASCADE,
    product_id INTEGER REFERENCES products(id) ON DELETE CASCADE,
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    price DECIMAL(10,2) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(cart_id, product_id)
);
```

#### **addresses** (Refactoris√©e - Plus clean)

```sql
CREATE TABLE addresses (
    id SERIAL PRIMARY KEY,
    label VARCHAR(100), -- 'Domicile', 'Bureau', 'Chez mes parents'
    address_line_1 VARCHAR(255) NOT NULL,
    address_line_2 VARCHAR(255),
    city VARCHAR(100) NOT NULL,
    state VARCHAR(100), -- R√©gion pour le S√©n√©gal
    postal_code VARCHAR(20),
    country VARCHAR(100) NOT NULL DEFAULT 'S√©n√©gal',
    landmark VARCHAR(255), -- Point de rep√®re (tr√®s important au S√©n√©gal)
    delivery_instructions TEXT, -- Instructions sp√©ciales de livraison
    coordinates POINT, -- Coordonn√©es GPS (latitude, longitude)
    is_verified BOOLEAN DEFAULT false, -- Adresse v√©rifi√©e par GPS/livreur
    tenant_id INTEGER REFERENCES tenants(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Table de liaison pour associer adresses aux utilisateurs
CREATE TABLE user_addresses (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    address_id INTEGER REFERENCES addresses(id) ON DELETE CASCADE,
    contact_person VARCHAR(100), -- Qui contacter √† cette adresse
    phone VARCHAR(20), -- T√©l√©phone sp√©cifique √† cette adresse
    type VARCHAR(20) CHECK (type IN ('billing', 'shipping', 'both')) DEFAULT 'both',
    is_default BOOLEAN DEFAULT false,
    notes TEXT, -- Notes sp√©ciales pour cette adresse
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, address_id, type)
);

-- Index pour les requ√™tes fr√©quentes
CREATE INDEX idx_user_addresses_user_default ON user_addresses(user_id, is_default);
CREATE INDEX idx_addresses_tenant ON addresses(tenant_id);
CREATE INDEX idx_addresses_city ON addresses(city);
```

#### **Comparaison Avant/Apr√®s**

**‚ùå AVANT (Surcharg√©e):**

```sql
CREATE TABLE addresses (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER REFERENCES tenants(id),
    first_name VARCHAR(50) NOT NULL,     -- ‚Üê R√©p√®te user_profile
    last_name VARCHAR(50) NOT NULL,      -- ‚Üê R√©p√®te user_profile
    company VARCHAR(100),                -- ‚Üê Optionnel, peut √™tre dans profile
    address_line_1 VARCHAR(255) NOT NULL,
    address_line_2 VARCHAR(255),
    city VARCHAR(100) NOT NULL,
    state VARCHAR(100),
    postal_code VARCHAR(20) NOT NULL,
    country VARCHAR(100) NOT NULL,
    phone VARCHAR(20),                   -- ‚Üê R√©p√®te user_profile
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);
```

**‚úÖ APR√àS (Optimis√©e):**

```sql
CREATE TABLE addresses (
    id SERIAL PRIMARY KEY,
    label VARCHAR(100),                  -- ‚úÖ Plus descriptif
    address_line_1 VARCHAR(255) NOT NULL,
    address_line_2 VARCHAR(255),
    city VARCHAR(100) NOT NULL,
    state VARCHAR(100),
    postal_code VARCHAR(20),
    country VARCHAR(100) DEFAULT 'S√©n√©gal',
    landmark VARCHAR(255),               -- ‚úÖ Sp√©cifique au contexte s√©n√©galais
    delivery_instructions TEXT,          -- ‚úÖ Instructions de livraison
    coordinates POINT,                   -- ‚úÖ GPS pour g√©olocalisation
    is_verified BOOLEAN DEFAULT false,   -- ‚úÖ Validation par livreur
    tenant_id INTEGER REFERENCES tenants(id),
    created_at TIMESTAMP,
    updated_at TIMESTAMP
);

CREATE TABLE user_addresses (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    address_id INTEGER REFERENCES addresses(id),
    contact_person VARCHAR(100),         -- ‚úÖ Qui contacter (peut √™tre diff√©rent)
    phone VARCHAR(20),                   -- ‚úÖ T√©l√©phone sp√©cifique √† l'adresse
    type VARCHAR(20) CHECK (type IN ('billing', 'shipping', 'both')),
    is_default BOOLEAN DEFAULT false,
    notes TEXT,                          -- ‚úÖ Notes sp√©ciales
    created_at TIMESTAMP
);
```

### **Avantages de cette Approche :**

#### **1. S√©paration des Pr√©occupations**

- **Adresses** : Uniquement les informations g√©ographiques
- **User_Addresses** : Relation et contexte d'utilisation
- **User_Profile** : Informations personnelles de l'utilisateur

#### **2. R√©utilisabilit√©**

```sql
-- Une adresse peut √™tre utilis√©e par plusieurs utilisateurs (famille, bureau)
INSERT INTO user_addresses (user_id, address_id, contact_person, phone, type) VALUES
(1, 100, 'John Doe', '+221701234567', 'shipping'),
(2, 100, 'Jane Doe', '+221707654321', 'shipping'); -- M√™me adresse, contacts diff√©rents
```

#### **3. Flexibilit√© Contexte S√©n√©galais**

```sql
-- Exemple d'adresse s√©n√©galaise typique
INSERT INTO addresses (
    label,
    address_line_1,
    city,
    state,
    country,
    landmark,
    delivery_instructions,
    coordinates
) VALUES (
    'Domicile',
    'Cit√© Keur Gorgui, Villa N¬∞25',
    'Dakar',
    'Dakar',
    'S√©n√©gal',
    'Face √† la mosqu√©e Keur Gorgui, portail bleu',
    'Appeler 15 minutes avant la livraison. Demander Aminata au gardien.',
    POINT(14.6928, -17.4467)
);
```

#### **4. Gestion Multi-Contact**

```sql
-- Un utilisateur peut avoir des contacts diff√©rents selon l'adresse
INSERT INTO user_addresses (user_id, address_id, contact_person, phone, type, notes) VALUES
(1, 101, 'Amadou Diallo', '+221701234567', 'shipping', 'Mon fr√®re, disponible 8h-18h'),
(1, 102, 'Fatou Sall', '+221707654321', 'shipping', 'Ma s≈ìur, disponible week-end uniquement');
```

### **Mod√®les Mis √† Jour**

#### **Address Model**

```typescript
export default class Address extends BaseModel {
  @column({ isPrimary: true })
  declare id: number

  @column()
  declare label: string | null

  @column()
  declare addressLine1: string

  @column()
  declare addressLine2: string | null

  @column()
  declare city: string

  @column()
  declare state: string | null

  @column()
  declare postalCode: string | null

  @column()
  declare country: string

  @column()
  declare landmark: string | null

  @column()
  declare deliveryInstructions: string | null

  @column()
  declare coordinates: string | null // Stock√© comme "lat,lng"

  @column()
  declare isVerified: boolean

  @column()
  declare tenantId: number

  @column.dateTime({ autoCreate: true })
  declare createdAt: DateTime

  @column.dateTime({ autoCreate: true, autoUpdate: true })
  declare updatedAt: DateTime

  // Relations
  @manyToMany(() => User, {
    pivotTable: 'user_addresses',
    pivotColumns: ['contact_person', 'phone', 'type', 'is_default', 'notes'],
  })
  declare users: ManyToMany<typeof User>

  // Helpers
  get fullAddress(): string {
    const parts = [
      this.addressLine1,
      this.addressLine2,
      this.city,
      this.state,
      this.postalCode,
      this.country,
    ].filter(Boolean)

    return parts.join(', ')
  }

  get googleMapsUrl(): string | null {
    if (!this.coordinates) return null
    return `https://maps.google.com/maps?q=${this.coordinates}`
  }
}
```

#### **UserAddress Model (Pivot)**

```typescript
export default class UserAddress extends BaseModel {
  static table = 'user_addresses'

  @column({ isPrimary: true })
  declare id: number

  @column()
  declare userId: number

  @column()
  declare addressId: number

  @column()
  declare contactPerson: string | null

  @column()
  declare phone: string | null

  @column()
  declare type: 'billing' | 'shipping' | 'both'

  @column()
  declare isDefault: boolean

  @column()
  declare notes: string | null

  @column.dateTime({ autoCreate: true })
  declare createdAt: DateTime

  // Relations
  @belongsTo(() => User)
  declare user: BelongsTo<typeof User>

  @belongsTo(() => Address)
  declare address: BelongsTo<typeof Address>
}
```

Cette approche est **beaucoup plus propre et flexible** ! üéØ

#### **orders** & **order_items** (Mis √† jour pour COD)

```sql
CREATE TABLE orders (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
    tenant_id INTEGER REFERENCES tenants(id) ON DELETE CASCADE,
    order_number VARCHAR(50) UNIQUE NOT NULL,

    -- Statuts adapt√©s pour COD
    status VARCHAR(30) CHECK (status IN (
        'pending',           -- En attente (panier converti)
        'confirmed',         -- Confirm√©e (stock r√©serv√©)
        'processing',        -- En pr√©paration
        'ready_for_pickup',  -- Pr√™te pour collecte (COD)
        'out_for_delivery',  -- En cours de livraison (COD)
        'payment_pending',   -- Paiement en attente √† la livraison (COD)
        'paid',             -- Pay√©e (carte/mobile money OU COD collect√©)
        'delivered',        -- Livr√©e et pay√©e
        'failed_delivery',  -- √âchec de livraison (COD refus√©/absent)
        'returned',         -- Retourn√©e (apr√®s √©chec COD)
        'cancelled',        -- Annul√©e
        'refunded'          -- Rembours√©e
    )) DEFAULT 'pending',

    -- Type de paiement
    payment_method VARCHAR(30) CHECK (payment_method IN (
        'cash_on_delivery',  -- Paiement √† la livraison
        'orange_money',      -- Orange Money S√©n√©gal
        'free_money',        -- Free Money (Tigo)
        'wave',             -- Wave
        'credit_card',      -- Carte bancaire
        'bank_transfer',    -- Virement
        'cheque'           -- Ch√®que
    )) NOT NULL,

    -- Addresses
    shipping_address_id INTEGER REFERENCES addresses(id),
    billing_address_id INTEGER REFERENCES addresses(id),

    -- Amounts (en XOF pour le S√©n√©gal)
    subtotal DECIMAL(12,2) NOT NULL, -- Montants plus √©lev√©s en XOF
    tax_amount DECIMAL(12,2) DEFAULT 0,
    shipping_amount DECIMAL(12,2) DEFAULT 0,
    cod_fee DECIMAL(12,2) DEFAULT 0, -- Frais COD sp√©cifiques
    discount_amount DECIMAL(12,2) DEFAULT 0,
    total_amount DECIMAL(12,2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'XOF', -- Franc CFA

    -- COD specific fields
    cod_instructions TEXT, -- Instructions sp√©ciales pour le livreur COD
    cod_collected_amount DECIMAL(12,2), -- Montant r√©ellement collect√©
    cod_collection_notes TEXT, -- Notes du livreur sur la collecte

    -- Timestamps
    confirmed_at TIMESTAMP,
    ready_at TIMESTAMP, -- Pr√™te pour livraison
    shipped_at TIMESTAMP,
    delivered_at TIMESTAMP,
    payment_collected_at TIMESTAMP, -- Quand le paiement COD a √©t√© collect√©

    -- Metadata
    notes TEXT,
    internal_notes TEXT, -- Notes internes (pas visibles client)
    delivery_attempts INTEGER DEFAULT 0, -- Nombre de tentatives de livraison

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE order_items (
    id SERIAL PRIMARY KEY,
    order_id INTEGER REFERENCES orders(id) ON DELETE CASCADE,
    product_id INTEGER REFERENCES products(id) ON DELETE CASCADE,
    quantity INTEGER NOT NULL CHECK (quantity > 0),
    unit_price DECIMAL(12,2) NOT NULL, -- Prix en XOF
    total_price DECIMAL(12,2) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Index pour optimiser les requ√™tes par statut et m√©thode de paiement
CREATE INDEX idx_orders_status ON orders(status);
CREATE INDEX idx_orders_payment_method ON orders(payment_method);
CREATE INDEX idx_orders_cod_status ON orders(status, payment_method) WHERE payment_method = 'cash_on_delivery';
```

### **Workflow des Statuts avec COD**

#### **Workflow Standard (Paiement √âlectronique)**

```
pending ‚Üí confirmed ‚Üí processing ‚Üí shipped ‚Üí delivered
   ‚Üì         ‚Üì           ‚Üì          ‚Üì
cancelled ‚Üê cancelled ‚Üê cancelled ‚Üê failed_delivery ‚Üí returned
                                    ‚Üì
                                 refunded
```

#### **Workflow COD (Cash on Delivery)**

```
pending ‚Üí confirmed ‚Üí processing ‚Üí ready_for_pickup ‚Üí out_for_delivery
   ‚Üì         ‚Üì           ‚Üì              ‚Üì                    ‚Üì
cancelled ‚Üê cancelled ‚Üê cancelled ‚Üê cancelled          payment_pending
                                                            ‚Üì
                                                         paid ‚Üí delivered
                                                            ‚Üì
                                                     failed_delivery
                                                            ‚Üì
                                                      returned ‚Üí refunded
```

#### **D√©tails des Statuts COD**

| Statut             | Description                             | Actions Possibles          | Responsable        |
| ------------------ | --------------------------------------- | -------------------------- | ------------------ |
| `pending`          | Commande cr√©√©e, en attente confirmation | confirmer, annuler         | Admin/Auto         |
| `confirmed`        | Stock r√©serv√©, commande valid√©e         | traiter, annuler           | Admin              |
| `processing`       | En cours de pr√©paration                 | pr√™te pour collecte        | √âquipe pr√©paration |
| `ready_for_pickup` | Pr√™te pour collecte par livreur         | assigner livreur           | Admin              |
| `out_for_delivery` | En cours de livraison                   | livr√©, √©chec               | Livreur            |
| `payment_pending`  | √Ä l'adresse, en attente paiement        | paiement collect√©, √©chec   | Livreur            |
| `paid`             | Paiement collect√© avec succ√®s           | livr√©                      | Livreur            |
| `delivered`        | Livr√©e et pay√©e                         | -                          | -                  |
| `failed_delivery`  | √âchec de livraison (absent/refus)       | nouvelle tentative, retour | Livreur            |
| `returned`         | Retourn√©e au d√©p√¥t                      | rembourser                 | Admin              |

### **Endpoints Sp√©cifiques COD**

```typescript
// Routes suppl√©mentaires pour COD
router
  .group(() => {
    // Livreur confirme l'arriv√©e et demande paiement
    router.post('/orders/:id/request-payment', [OrderController, 'requestPayment'])

    // Livreur confirme la collecte du paiement
    router.post('/orders/:id/confirm-payment', [OrderController, 'confirmPayment'])

    // Livreur signale un √©chec de livraison
    router.post('/orders/:id/report-delivery-failure', [OrderController, 'reportDeliveryFailure'])

    // Programmer une nouvelle tentative
    router.post('/orders/:id/schedule-retry', [OrderController, 'scheduleRetry'])
  })
  .prefix('/api/delivery')
  .middleware(['auth', 'tenant'])
```

Cette approche int√®gre compl√®tement le workflow COD sp√©cifique au contexte s√©n√©galais ! üá∏üá≥

#### **payments**

```sql
CREATE TABLE payments (
    id SERIAL PRIMARY KEY,
    order_id INTEGER REFERENCES orders(id) ON DELETE CASCADE,
    amount DECIMAL(10,2) NOT NULL,
    currency VARCHAR(3) DEFAULT 'EUR',
    method VARCHAR(50) NOT NULL,
    status VARCHAR(20) CHECK (status IN ('pending', 'processing', 'completed', 'failed', 'refunded')) DEFAULT 'pending',
    gateway VARCHAR(50),
    gateway_transaction_id VARCHAR(255),
    gateway_response JSONB,
    processed_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### **delivery_zones**, **deliveries**, **delivery_people**

```sql
CREATE TABLE delivery_zones (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    tenant_id INTEGER REFERENCES tenants(id) ON DELETE CASCADE,
    cities JSONB NOT NULL DEFAULT '[]',
    postal_codes JSONB NOT NULL DEFAULT '[]',
    delivery_fee DECIMAL(10,2) NOT NULL DEFAULT 0,
    free_delivery_threshold DECIMAL(10,2),
    estimated_delivery_time VARCHAR(50),
    is_active BOOLEAN DEFAULT true,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE delivery_people (
    id SERIAL PRIMARY KEY,
    tenant_id INTEGER REFERENCES tenants(id) ON DELETE CASCADE,
    first_name VARCHAR(50) NOT NULL,
    last_name VARCHAR(50) NOT NULL,
    phone VARCHAR(20) NOT NULL,
    email VARCHAR(100),
    vehicle_type VARCHAR(50),
    license_number VARCHAR(100),
    status VARCHAR(20) CHECK (status IN ('active', 'inactive', 'busy')) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE deliveries (
    id SERIAL PRIMARY KEY,
    order_id INTEGER REFERENCES orders(id) ON DELETE CASCADE,
    delivery_person_id INTEGER REFERENCES delivery_people(id),
    delivery_zone_id INTEGER REFERENCES delivery_zones(id),
    tracking_number VARCHAR(100) UNIQUE,
    status VARCHAR(20) CHECK (status IN ('assigned', 'picked_up', 'in_transit', 'out_for_delivery', 'delivered', 'failed', 'returned')) DEFAULT 'assigned',
    scheduled_at TIMESTAMP,
    picked_up_at TIMESTAMP,
    delivered_at TIMESTAMP,
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## üìä Sp√©cifications des Modules Critiques (P0)

### üîê MODULE AUTH (Authentification & Autorisation)

**Responsabilit√©s**:

- Authentification (AuthN): "Qui √™tes-vous ?"
- Autorisation (AuthZ): "Que pouvez-vous faire ?"
- Gestion des tokens JWT
- Sessions et s√©curit√©
- Audit des connexions

**Endpoints Principaux**:

- `POST /auth/login` - Connexion utilisateur
- `POST /auth/logout` - D√©connexion
- `GET /auth/me` - Profil utilisateur actuel
- `POST /auth/validate-token` - Validation token
- `POST /auth/refresh` - Renouvellement token

**Middleware de S√©curit√©**:

**Endpoints CRUD Complets**:

- `GET /users` - Liste pagin√©e avec filtres
- `POST /users` - Cr√©ation utilisateur
- `PUT /users/:id` - Mise √† jour utilisateur
- `DELETE /users/:id` - Suppression utilisateur
- `PUT /users/:id/profile` - Mise √† jour profil
- `GET /users/me/profile` - Profil personnel
- `PUT /users/me/change-password` - Changement mot de passe

---

### üè¢ MODULE TENANT (Multi-Tenant)

**Responsabilit√©s**:

- Isolation des donn√©es par tenant
- Gestion des contextes tenant
- Configuration par tenant
- Domaines et sous-domaines
- Th√®mes et personnalisation

**R√©solution Multi-Tenant**:

**Headers Multi-Tenant**:

```
Authorization: Bearer {token}
Content-Type: application/json
X-Tenant-Slug: apple-store  ‚Üê ESSENTIEL
```

---

### üõçÔ∏è MODULE CATALOG (Produits & Catalogue)

**Responsabilit√©s**:

- CRUD produits complet
- Syst√®me de cat√©gories hi√©rarchique
- Gestion des stocks (inventory)
- Upload et gestion d'images
- Recherche et filtres avanc√©s
- SEO et URLs friendly

**Fonctionnalit√©s Avanc√©es**:

- **Recherche multi-crit√®res**: nom, cat√©gorie, prix, stock
- **Filtres dynamiques**: marque, prix, disponibilit√©
- **Pagination optimis√©e**: performance avec grandes collections
- **Gestion d'images**: upload, redimensionnement, optimisation
- **Variations produits**: couleurs, tailles, options
- **SEO**: meta descriptions, URLs optimis√©es

**Endpoints Critiques**:

- `GET /products` - Liste avec filtres et pagination
- `GET /products/search` - Recherche avanc√©e avec facettes
- `POST /products` - Cr√©ation produit avec validation
- `PUT /products/:id/inventory` - Gestion stocks
- `POST /products/:id/images` - Upload images

---

### üõí MODULE CART (Panier d'Achat)

**Responsabilit√©s**:

- Gestion du panier utilisateur
- Calculs automatiques (sous-total, taxes, livraison)
- Persistance entre sessions
- Gestion des stocks en temps r√©el
- Application de coupons/promotions

### üì¶ MODULE ORDERS (Commandes)

**Responsabilit√©s**:

- Workflow complet de commande
- Gestion des statuts (pending ‚Üí paid ‚Üí shipped ‚Üí delivered)
- Calculs avec taxes et frais de livraison
- Gestion des adresses de livraison/facturation
- Historique et suivi
- Int√©gration avec paiements et livraisons

**Workflow des Statuts**:

```
pending ‚Üí paid ‚Üí processing ‚Üí shipped ‚Üí delivered
    ‚Üì       ‚Üì         ‚Üì         ‚Üì
cancelled ‚Üê cancelled ‚Üê cancelled ‚Üê returned
                                    ‚Üì
                                refunded
```

**Endpoints Critiques**:

- `POST /orders` - Cr√©ation depuis panier avec validation compl√®te
- `GET /orders/:id` - D√©tails avec timeline et tracking
- `PUT /orders/:id/status` - Mise √† jour statut avec workflow
- `POST /orders/:id/cancel` - Annulation avec remise en stock
- `GET /orders/:id/tracking` - Suivi de livraison

---

### **Codes HTTP Standard**

| Code | Description           | Usage                    |
| ---- | --------------------- | ------------------------ |
| 200  | OK                    | GET, PUT r√©ussis         |
| 201  | Created               | POST r√©ussi              |
| 204  | No Content            | DELETE r√©ussi            |
| 400  | Bad Request           | Erreurs de validation    |
| 401  | Unauthorized          | Authentification requise |
| 403  | Forbidden             | Permission refus√©e       |
| 404  | Not Found             | Ressource non trouv√©e    |
| 409  | Conflict              | Ressource dupliqu√©e      |
| 422  | Unprocessable Entity  | Validation √©chou√©e       |
| 429  | Too Many Requests     | Rate limit d√©pass√©       |
| 500  | Internal Server Error | Erreur serveur           |

---

## üß™ Strat√©gie de Tests

### **Tests Unitaires** (Should Have - 20% du temps)

```typescript
// Exemple: Auth Service Tests
import { test } from '@japa/runner'
import AuthenticationService from '#modules/auth/services/authentication_service'

test.group('Authentication Service', () => {
  test('should authenticate valid user', async ({ assert }) => {
    const authService = new AuthenticationService()
    const credentials = {
      email: 'admin@example.com',
      password: 'password123',
    }

    const result = await authService.authenticate(credentials, mockAuth)

    assert.isTrue(result.user.id > 0)
    assert.isString(result.tokens.accessToken)
    assert.equal(result.tokens.expiresIn, 7200)
  })

  test('should throw error for invalid credentials', async ({ assert }) => {
    const authService = new AuthenticationService()
    const credentials = {
      email: 'invalid@example.com',
      password: 'wrongpassword',
    }

    await assert.rejects(
      () => authService.authenticate(credentials, mockAuth),
      'Email ou mot de passe incorrect'
    )
  })
})
```

### **Coverage Target**

- **Modules critiques**: 80%+ coverage
- **Services m√©tier**: 90%+ coverage
- **Contr√¥leurs**: 70%+ coverage
- **Middleware**: 85%+ coverage
 Installation Initiale**

### **2. Configuration Base de Donn√©es**

### **4. Test des APIs**

```bash
# Test de sant√©
curl http://localhost:3333/api/health

# Test de login
curl -X POST http://localhost:3333/api/auth/login \
  -H "Content-Type: application/json" \
  -H "X-Tenant-Slug: test-store" \
  -d '{"email":"admin@example.com","password":"password123"}'

# Test avec token (remplacer TOKEN)
curl -X GET http://localhost:3333/api/auth/me \
  -H "Authorization: Bearer TOKEN" \
  -H "X-Tenant-Slug: test-store"
```

## üéØ Definition of Done

### **Feature "Done" Criteria**

```
Une feature est "Done" quand:
‚ñ° Code impl√©ment√© et fonctionnel
‚ñ° Tests unitaires passent (coverage > 70%)
‚ñ° Documentation API √† jour
‚ñ° Test√© manuellement via Postman
‚ñ° Code review (self-review OK)
‚ñ° Git commit avec message descriptif
‚ñ° Integration avec modules existants valid√©e
‚ñ° Gestion d'erreurs impl√©ment√©e
‚ñ° Validation des donn√©es en place
‚ñ° Logs et audit configur√©s
```

### **API Endpoint "Ready" Criteria**

```
Un endpoint est "Ready" quand:
‚ñ° Headers requis document√©s
‚ñ° Param√®tres valid√©s avec Vine
‚ñ° R√©ponses standardis√©es (success/error)
‚ñ° Codes HTTP appropri√©s
‚ñ° Gestion d'erreurs compl√®te
‚ñ° Tests d'int√©gration passent
‚ñ° Documentation Postman √† jour
‚ñ° Middleware de s√©curit√© appliqu√©
‚ñ° Rate limiting configur√© (si n√©cessaire)
‚ñ° Logs d'audit en place
```

### **Module "Production Ready" Criteria**

```
Un module est "Production Ready" quand:
‚ñ° Tous les endpoints sont "Ready"
‚ñ° Tests de charge valid√©s
‚ñ° S√©curit√© audit√©e
‚ñ° Performance optimis√©e
‚ñ° Monitoring en place
‚ñ° Documentation technique compl√®te
‚ñ° Gestion d'erreurs robuste
‚ñ° Rollback strat√©gies d√©finies
‚ñ° Environment variables s√©curis√©es
‚ñ° Backup/restore proc√©dures document√©es
```

---

## üìä M√©triques de Succ√®s

### **Objectifs Techniques**

- **71 endpoints** document√©s et fonctionnels
- **Coverage tests** > 70% sur modules critiques
- **Performance** < 200ms response time average
- **S√©curit√©** audit complet pass√©
- **Documentation** API compl√®te et √† jour

### **Objectifs Business**

- **Workflow e-commerce** complet end-to-end
- **Multi-tenant** isolation valid√©e
- **Scalabilit√©** architecture pr√™te pour 1000+ tenants
- **Maintenance** code modulaire et maintenable
- **Deployment** pr√™t pour production

### **Ready for Frontend**

- ‚úÖ 50+ API endpoints document√©s
- ‚úÖ Authentication flow complet
- ‚úÖ E-commerce workflow end-to-end
- ‚úÖ Error handling standardis√©
- ‚úÖ CORS configur√© pour frontend
- ‚úÖ Environment variables setup
- ‚úÖ Rate limiting impl√©ment√©
- ‚úÖ Security audit pass√©

---

## üèÅ Conclusion

Ce backend e-commerce AdonisJS modulaire repr√©sente une architecture moderne, scalable et s√©curis√©e, pr√™te pour le d√©veloppement en 3 jours intensifs.

**Points forts de l'architecture**:

- **Modularit√©**: S√©paration claire des domaines (DDD)
- **S√©curit√©**: JWT robuste avec validation compl√®te
- **Multi-tenant**: Isolation parfaite des donn√©es
- **Scalabilit√©**: Architecture pr√™te pour croissance
- **Maintenabilit√©**: Code organis√© et document√©
